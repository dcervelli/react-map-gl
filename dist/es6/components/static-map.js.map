{"version":3,"sources":["../../../src/components/static-map.js"],"names":["PureComponent","createElement","PropTypes","normalizeStyle","WebMercatorViewport","Mapbox","isBrowser","checkVisibilityConstraints","mapboxgl","require","TOKEN_DOC_URL","NO_TOKEN_WARNING","noop","UNAUTHORIZED_ERROR_CODE","propTypes","Object","assign","mapStyle","oneOfType","string","object","preventStyleDiffing","bool","disableTokenWarning","visible","visibilityConstraints","defaultProps","childContextTypes","viewport","instanceOf","StaticMap","supported","constructor","props","_map","geometry","options","queryRenderedFeatures","ref","_mapboxMap","evt","statusCode","error","status","state","accessTokenInvalid","console","setState","_queryParams","componentDidMount","componentWillReceiveProps","componentDidUpdate","componentWillUnmount","getChildContext","_mapbox","container","onError","_mapboxMapError","getMap","newProps","setProps","_updateMapStyle","width","height","_updateMapSize","finalize","oldProps","sizeChanged","resize","oldMapStyle","setStyle","diff","_renderNoTokenWarning","style","position","left","top","key","id","href","render","className","mapContainerStyle","viewState","visibility","overlayContainerStyle","overflow","children","_mapboxMapLoaded","displayName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {PureComponent, createElement} from 'react';\nimport PropTypes from 'prop-types';\n\nimport {normalizeStyle} from '../utils/style-utils';\n\nimport WebMercatorViewport from 'viewport-mercator-project';\n\nimport Mapbox from '../mapbox/mapbox';\nimport isBrowser from '../utils/is-browser';\nimport {checkVisibilityConstraints} from '../utils/map-constraints';\n\nconst mapboxgl = isBrowser ? require('mapbox-gl') : null;\n\n/* eslint-disable max-len */\nconst TOKEN_DOC_URL = 'https://uber.github.io/react-map-gl/#/Documentation/getting-started/about-mapbox-tokens';\nconst NO_TOKEN_WARNING = 'A valid API access token is required to use Mapbox data';\n/* eslint-disable max-len */\n\nfunction noop() {}\n\nconst UNAUTHORIZED_ERROR_CODE = 401;\n\nconst propTypes = Object.assign({}, Mapbox.propTypes, {\n  /** The Mapbox style. A string url or a MapboxGL style Immutable.Map object. */\n  mapStyle: PropTypes.oneOfType([\n    PropTypes.string,\n    PropTypes.object\n  ]),\n  /** There are known issues with style diffing. As stopgap, add option to prevent style diffing. */\n  preventStyleDiffing: PropTypes.bool,\n  /** Hide invalid token warning even if request fails */\n  disableTokenWarning: PropTypes.bool,\n  /** Whether the map is visible */\n  visible: PropTypes.bool,\n\n  /** Advanced features */\n  // Contraints for displaying the map. If not met, then the map is hidden.\n  // Experimental! May be changed in minor version updates.\n  visibilityConstraints: PropTypes.object\n});\n\nconst defaultProps = Object.assign({}, Mapbox.defaultProps, {\n  mapStyle: 'mapbox://styles/mapbox/light-v8',\n  preventStyleDiffing: false,\n  visible: true\n});\n\nconst childContextTypes = {\n  viewport: PropTypes.instanceOf(WebMercatorViewport)\n};\n\nexport default class StaticMap extends PureComponent {\n  static supported() {\n    return mapboxgl && mapboxgl.supported();\n  }\n\n  constructor(props) {\n    super(props);\n    this._queryParams = {};\n    if (!StaticMap.supported()) {\n      this.componentDidMount = noop;\n      this.componentWillReceiveProps = noop;\n      this.componentDidUpdate = noop;\n      this.componentWillUnmount = noop;\n    }\n    this.state = {\n      accessTokenInvalid: false\n    };\n  }\n\n  getChildContext() {\n    return {\n      viewport: new WebMercatorViewport(this.props)\n    };\n  }\n\n  componentDidMount() {\n    const {mapStyle} = this.props;\n\n    this._mapbox = new Mapbox(Object.assign({}, this.props, {\n      mapboxgl, // Handle to mapbox-gl library\n      container: this._mapboxMap,\n      onError: this._mapboxMapError,\n      mapStyle: normalizeStyle(mapStyle)\n    }));\n    this._map = this._mapbox.getMap();\n  }\n\n  componentWillReceiveProps(newProps) {\n    this._mapbox.setProps(newProps);\n    this._updateMapStyle(this.props, newProps);\n\n    // this._updateMapViewport(this.props, newProps);\n\n    // Save width/height so that we can check them in componentDidUpdate\n    this.setState({\n      width: this.props.width,\n      height: this.props.height\n    });\n  }\n\n  componentDidUpdate() {\n    // Since Mapbox's map.resize() reads size from DOM\n    // we must wait to read size until after render (i.e. here in \"didUpdate\")\n    this._updateMapSize(this.state, this.props);\n  }\n\n  componentWillUnmount() {\n    this._mapbox.finalize();\n    this._mapbox = null;\n    this._map = null;\n  }\n\n  // External apps can access map this way\n  getMap = () => {\n    return this._map;\n  }\n\n  /** Uses Mapbox's\n    * queryRenderedFeatures API to find features at point or in a bounding box.\n    * https://www.mapbox.com/mapbox-gl-js/api/#Map#queryRenderedFeatures\n    * To query only some of the layers, set the `interactive` property in the\n    * layer style to `true`.\n    * @param {[Number, Number]|[[Number, Number], [Number, Number]]} geometry -\n    *   Point or an array of two points defining the bounding box\n    * @param {Object} options - query options\n    */\n  queryRenderedFeatures = (geometry, options = {}) => {\n    return this._map.queryRenderedFeatures(geometry, options);\n  }\n\n  // Note: needs to be called after render (e.g. in componentDidUpdate)\n  _updateMapSize(oldProps, newProps) {\n    const sizeChanged =\n      oldProps.width !== newProps.width || oldProps.height !== newProps.height;\n\n    if (sizeChanged) {\n      this._map.resize();\n      // this._callOnChangeViewport(this._map.transform);\n    }\n  }\n\n  _updateMapStyle(oldProps, newProps) {\n    const mapStyle = newProps.mapStyle;\n    const oldMapStyle = oldProps.mapStyle;\n    if (mapStyle !== oldMapStyle) {\n      this._map.setStyle(normalizeStyle(mapStyle), {diff: !this.props.preventStyleDiffing});\n    }\n  }\n\n  _mapboxMapLoaded = (ref) => {\n    this._mapboxMap = ref;\n  }\n\n  // Handle map error\n  _mapboxMapError = (evt) => {\n    const statusCode = evt.error && evt.error.status || evt.status;\n    if (statusCode === UNAUTHORIZED_ERROR_CODE && !this.state.accessTokenInvalid) {\n      // Mapbox throws unauthorized error - invalid token\n      console.error(NO_TOKEN_WARNING); // eslint-disable-line\n      this.setState({accessTokenInvalid: true});\n    }\n  }\n\n  _renderNoTokenWarning() {\n    if (this.state.accessTokenInvalid && !this.props.disableTokenWarning) {\n      const style = {\n        position: 'absolute',\n        left: 0,\n        top: 0\n      };\n      return (\n        createElement('div', {key: 'warning', id: 'no-token-warning', style}, [\n          createElement('h3', {key: 'header'}, NO_TOKEN_WARNING),\n          createElement('div', {key: 'text'}, 'For information on setting up your basemap, read'),\n          createElement('a', {key: 'link', href: TOKEN_DOC_URL}, 'Note on Map Tokens')\n        ])\n      );\n    }\n\n    return null;\n  }\n\n  render() {\n    const {className, width, height, style, visibilityConstraints} = this.props;\n    const mapContainerStyle = Object.assign({}, style, {width, height, position: 'relative'});\n\n    const visible = this.props.visible &&\n      checkVisibilityConstraints(this.props.viewState || this.props, visibilityConstraints);\n\n    const mapStyle = Object.assign({}, style, {\n      width,\n      height,\n      visibility: visible ? 'visible' : 'hidden'\n    });\n    const overlayContainerStyle = {\n      position: 'absolute',\n      left: 0,\n      top: 0,\n      width,\n      height,\n      overflow: 'hidden'\n    };\n\n    // Note: a static map still handles clicks and hover events\n    return (\n      createElement('div', {\n        key: 'map-container',\n        style: mapContainerStyle,\n        children: [\n          createElement('div', {\n            key: 'map-mapbox',\n            ref: this._mapboxMapLoaded,\n            style: mapStyle,\n            className\n          }),\n          createElement('div', {\n            key: 'map-overlays',\n            // Same as interactive map's overlay container\n            className: 'overlays',\n            style: overlayContainerStyle,\n            children: this.props.children\n          }),\n          this._renderNoTokenWarning()\n        ]\n      })\n    );\n  }\n}\n\nStaticMap.displayName = 'StaticMap';\nStaticMap.propTypes = propTypes;\nStaticMap.defaultProps = defaultProps;\nStaticMap.childContextTypes = childContextTypes;\n"],"file":"static-map.js"}